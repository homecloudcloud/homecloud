import { Directive } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { isWithinBounds, stopPropagation } from './common';
import * as i0 from "@angular/core";
import * as i1 from "../ng-scrollbar-base";
import * as i2 from "@angular/cdk/platform";
// @dynamic
export class Scrollbar {
    constructor(el, cmp, platform, document, zone) {
        this.el = el;
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    activatePointerEvents() {
        // Stream that emits when scrollbar thumb is dragged
        let thumbDragEvent;
        // Stream that emits when scrollbar track is clicked
        let trackClickEvent;
        // Stream that emits when scrollbar track is hovered
        let trackHoveredEvent;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.cmp.viewportPropagateMouseMove, this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((e) => e ? isWithinBounds(e, this.el.getBoundingClientRect()) : false), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((hovered) => this.document.onselectstart = hovered ? () => false : null));
            this.cmp.viewport.clicked.pipe(tap((e) => {
                if (e) {
                    if (isWithinBounds(e, this.thumb.clientRect)) {
                        this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, this.track.clientRect)) {
                        this.cmp.setClicked(true);
                        this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    this.cmp.setClicked(false);
                }
            }), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((e) => this.setHovered(e))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((e) => this.thumb.dragged(e))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((e) => this.track.onTrackClicked(e, this.thumb.size, this.viewportScrollSize))));
    }
    // Stream that emits when the track element is hovered
    get hovered() {
        const mouseEnter = fromEvent(this.el, 'mouseenter', { passive: true }).pipe(stopPropagation(), map(() => true));
        const mouseLeave = fromEvent(this.el, 'mouseleave', { passive: true }).pipe(stopPropagation(), map(() => false));
        return merge(mouseEnter, mouseLeave);
    }
    ngOnInit() {
        this.zone.runOutsideAngular(() => {
            // Activate pointer events on Desktop only
            if (!(this.platform.IOS || this.platform.ANDROID) && !this.cmp.pointerEventsDisabled) {
                this.activatePointerEvents().pipe(takeUntil(this.destroyed)).subscribe();
            }
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(this.cmp.scrolled, this.cmp.updated).pipe(tap(() => this.thumb?.update()), takeUntil(this.destroyed)).subscribe();
        });
    }
    ngOnDestroy() {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    }
}
Scrollbar.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.1", ngImport: i0, type: Scrollbar, deps: [{ token: HTMLElement }, { token: i1.NgScrollbarBase }, { token: i2.Platform }, { token: Document }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Directive });
Scrollbar.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.1.1", type: Scrollbar, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.1", ngImport: i0, type: Scrollbar, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: HTMLElement }, { type: i1.NgScrollbarBase }, { type: i2.Platform }, { type: Document }, { type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zcmMvbGliL3Njcm9sbGJhci9zY3JvbGxiYXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUE2QixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUl0RixPQUFPLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7OztBQUUzRCxXQUFXO0FBRVgsTUFBTSxPQUFnQixTQUFTO0lBa0I3QixZQUFnQyxFQUFlLEVBQ2xCLEdBQW9CLEVBQ2pCLFFBQWtCLEVBQ2xCLFFBQWtCLEVBQ2xCLElBQVk7UUFKWixPQUFFLEdBQUYsRUFBRSxDQUFhO1FBQ2xCLFFBQUcsR0FBSCxHQUFHLENBQWlCO1FBQ2pCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBaEI1QyxvREFBb0Q7UUFDakMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFnQm5ELENBQUM7SUFFRDs7T0FFRztJQUNLLHFCQUFxQjtRQUMzQixvREFBb0Q7UUFDcEQsSUFBSSxjQUFzQyxDQUFDO1FBQzNDLG9EQUFvRDtRQUNwRCxJQUFJLGVBQXVDLENBQUM7UUFDNUMsb0RBQW9EO1FBQ3BELElBQUksaUJBQXNDLENBQUM7UUFFM0Msb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsS0FBSyxVQUFVLEVBQUU7WUFDL0Msb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBYyxDQUFDO1lBQ3RELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBYyxDQUFDO1lBRXRELHdEQUF3RDtZQUN4RCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU5RixjQUFjO1lBQ2QsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztZQUMzQyxlQUFlLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1lBQzVDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJO1lBQ2pELDRCQUE0QjtZQUM1QixHQUFHLENBQUMsQ0FBQyxDQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUM5RixvQkFBb0IsRUFBRTtZQUN0QixrQ0FBa0M7WUFDbEMsR0FBRyxDQUFDLENBQUMsT0FBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUN0RixDQUFDO1lBRUYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDN0IsR0FBRyxDQUFDLENBQUMsQ0FBcUIsRUFBRSxFQUFFO2dCQUM1QixJQUFJLENBQUMsRUFBRTtvQkFDTCxJQUFJLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQU0sQ0FBQyxVQUFVLENBQUMsRUFBRTt3QkFDN0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDbkM7eUJBQU0sSUFBSSxjQUFjLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7d0JBQ3BELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUMxQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNuQztpQkFDRjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDNUI7WUFDSCxDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7YUFBTTtZQUNMLDZDQUE2QztZQUM3QyxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQU0sQ0FBQyxPQUFPLENBQUM7WUFDckMsZUFBZSxHQUFHLElBQUksQ0FBQyxLQUFNLENBQUMsT0FBTyxDQUFDO1lBQ3RDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDbEM7UUFFRCxPQUFPLEtBQUs7UUFDVixtQ0FBbUM7UUFDbkMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9ELHNDQUFzQztRQUN0QyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSx1Q0FBdUM7UUFDdkMsZUFBZSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQzdILENBQUM7SUFDSixDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELElBQWMsT0FBTztRQUNuQixNQUFNLFVBQVUsR0FBRyxTQUFTLENBQWEsSUFBSSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3JGLGVBQWUsRUFBRSxFQUNqQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQ2hCLENBQUM7UUFDRixNQUFNLFVBQVUsR0FBRyxTQUFTLENBQWEsSUFBSSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3JGLGVBQWUsRUFBRSxFQUNqQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQ2pCLENBQUM7UUFDRixPQUFPLEtBQUssQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRTtZQUMvQiwwQ0FBMEM7WUFDMUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7Z0JBQ3BGLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDMUU7WUFFRCwyRkFBMkY7WUFDM0YsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUM3QyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUMvQixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFMUIsb0NBQW9DO1FBQ3BDLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUMxRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQzs7c0dBN0htQixTQUFTLGtCQWtCTyxXQUFXLG9FQUdMLFFBQVE7MEZBckI5QixTQUFTOzJGQUFULFNBQVM7a0JBRDlCLFNBQVM7MERBbUI0QixXQUFXLGlFQUdMLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkRlc3Ryb3ksIE9uSW5pdCwgTmdab25lLCBEaXJlY3RpdmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBmcm9tRXZlbnQsIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE5nU2Nyb2xsYmFyQmFzZSB9IGZyb20gJy4uL25nLXNjcm9sbGJhci1iYXNlJztcclxuaW1wb3J0IHsgVGh1bWJBZGFwdGVyIH0gZnJvbSAnLi90aHVtYi90aHVtYic7XHJcbmltcG9ydCB7IFRyYWNrQWRhcHRlciB9IGZyb20gJy4vdHJhY2svdHJhY2snO1xyXG5pbXBvcnQgeyBpc1dpdGhpbkJvdW5kcywgc3RvcFByb3BhZ2F0aW9uIH0gZnJvbSAnLi9jb21tb24nO1xyXG5cclxuLy8gQGR5bmFtaWNcclxuQERpcmVjdGl2ZSgpXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTY3JvbGxiYXIgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIC8vIFRodW1iIGRpcmVjdGl2ZSByZWZlcmVuY2VcclxuICByZWFkb25seSB0aHVtYjogVGh1bWJBZGFwdGVyIHwgdW5kZWZpbmVkO1xyXG4gIC8vIFRyYWNrIGRpcmVjdGl2ZSByZWZlcmVuY2VcclxuICByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyIHwgdW5kZWZpbmVkO1xyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHRvIHVuc3Vic2NyaWJlIGZyb20gYWxsIHN0cmVhbXNcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICogVmlld3BvcnQgcG9pbnRlciBldmVudHNcclxuICAgKiBUaGUgZm9sbG93aW5nIHN0cmVhbXMgYXJlIG9ubHkgYWN0aXZhdGVkIHdoZW4gKHBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHZpZXdwb3J0VHJhY2tDbGlja2VkITogU3ViamVjdDxNb3VzZUV2ZW50PjtcclxuICBwcm90ZWN0ZWQgdmlld3BvcnRUaHVtYkNsaWNrZWQhOiBTdWJqZWN0PE1vdXNlRXZlbnQ+O1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZWw6IEhUTUxFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgY21wOiBOZ1Njcm9sbGJhckJhc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBwbGF0Zm9ybTogUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBkb2N1bWVudDogRG9jdW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCB6b25lOiBOZ1pvbmUpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFjdGl2YXRlIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYWN0aXZhdGVQb2ludGVyRXZlbnRzKCk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdGh1bWIgaXMgZHJhZ2dlZFxyXG4gICAgbGV0IHRodW1iRHJhZ0V2ZW50OiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQ+O1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgY2xpY2tlZFxyXG4gICAgbGV0IHRyYWNrQ2xpY2tFdmVudDogT2JzZXJ2YWJsZTxNb3VzZUV2ZW50PjtcclxuICAgIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIHRyYWNrIGlzIGhvdmVyZWRcclxuICAgIGxldCB0cmFja0hvdmVyZWRFdmVudDogT2JzZXJ2YWJsZTxib29sZWFuPjtcclxuXHJcbiAgICAvLyBTZXQgdGhlIG1ldGhvZCB1c2VkIGZvciB0aGUgcG9pbnRlciBldmVudHMgb3B0aW9uXHJcbiAgICBpZiAodGhpcy5jbXAucG9pbnRlckV2ZW50c01ldGhvZCA9PT0gJ3ZpZXdwb3J0Jykge1xyXG4gICAgICAvLyBQb2ludGVyIGV2ZW50cyB1c2luZyB0aGUgdmlld3BvcnRcclxuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PE1vdXNlRXZlbnQ+KCk7XHJcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgPSBuZXcgU3ViamVjdDxNb3VzZUV2ZW50PigpO1xyXG5cclxuICAgICAgLy8gQWN0aXZhdGUgdGhlIHBvaW50ZXIgZXZlbnRzIG9mIHRoZSB2aWV3cG9ydCBkaXJlY3RpdmVcclxuICAgICAgdGhpcy5jbXAudmlld3BvcnQhLmFjdGl2YXRlUG9pbnRlckV2ZW50cyh0aGlzLmNtcC52aWV3cG9ydFByb3BhZ2F0ZU1vdXNlTW92ZSwgdGhpcy5kZXN0cm95ZWQpO1xyXG5cclxuICAgICAgLy8gU2V0IHN0cmVhbXNcclxuICAgICAgdGh1bWJEcmFnRXZlbnQgPSB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkO1xyXG4gICAgICB0cmFja0NsaWNrRXZlbnQgPSB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkO1xyXG4gICAgICB0cmFja0hvdmVyZWRFdmVudCA9IHRoaXMuY21wLnZpZXdwb3J0IS5ob3ZlcmVkLnBpcGUoXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdHJhY2sgaXMgaG92ZXJlZFxyXG4gICAgICAgIG1hcCgoZTogTW91c2VFdmVudCB8IGZhbHNlKSA9PiBlID8gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSkgOiBmYWxzZSksXHJcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcclxuICAgICAgICAvLyBFbmFibGUgLyBkaXNhYmxlIHRleHQgc2VsZWN0aW9uXHJcbiAgICAgICAgdGFwKChob3ZlcmVkOiBib29sZWFuKSA9PiB0aGlzLmRvY3VtZW50Lm9uc2VsZWN0c3RhcnQgPSBob3ZlcmVkID8gKCkgPT4gZmFsc2UgOiBudWxsKVxyXG4gICAgICApO1xyXG5cclxuICAgICAgdGhpcy5jbXAudmlld3BvcnQhLmNsaWNrZWQucGlwZShcclxuICAgICAgICB0YXAoKGU6IE1vdXNlRXZlbnQgfCBmYWxzZSkgPT4ge1xyXG4gICAgICAgICAgaWYgKGUpIHtcclxuICAgICAgICAgICAgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudGh1bWIhLmNsaWVudFJlY3QpKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZC5uZXh0KGUpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2shLmNsaWVudFJlY3QpKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZCh0cnVlKTtcclxuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkLm5leHQoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY21wLnNldENsaWNrZWQoZmFsc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZClcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIG1ldGhvZCBpcyB1c2luZyAnc2Nyb2xsYmFyJ1xyXG4gICAgICB0aHVtYkRyYWdFdmVudCA9IHRoaXMudGh1bWIhLmNsaWNrZWQ7XHJcbiAgICAgIHRyYWNrQ2xpY2tFdmVudCA9IHRoaXMudHJhY2shLmNsaWNrZWQ7XHJcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50ID0gdGhpcy5ob3ZlcmVkO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtZXJnZShcclxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIGhvdmVyZWQgZXZlbnRcclxuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQucGlwZSh0YXAoKGU6IGJvb2xlYW4pID0+IHRoaXMuc2V0SG92ZXJlZChlKSkpLFxyXG4gICAgICAvLyBBY3RpdmF0ZSBzY3JvbGxiYXIgdGh1bWIgZHJhZyBldmVudFxyXG4gICAgICB0aHVtYkRyYWdFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogTW91c2VFdmVudCkgPT4gdGhpcy50aHVtYiEuZHJhZ2dlZChlKSkpLFxyXG4gICAgICAvLyBBY3RpdmF0ZSBzY3JvbGxiYXIgdHJhY2sgY2xpY2sgZXZlbnRcclxuICAgICAgdHJhY2tDbGlja0V2ZW50LnBpcGUoc3dpdGNoTWFwKChlOiBNb3VzZUV2ZW50KSA9PiB0aGlzLnRyYWNrIS5vblRyYWNrQ2xpY2tlZChlLCB0aGlzLnRodW1iIS5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSkpKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gdGhlIHRyYWNrIGVsZW1lbnQgaXMgaG92ZXJlZFxyXG4gIHByb3RlY3RlZCBnZXQgaG92ZXJlZCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IG1vdXNlRW50ZXIgPSBmcm9tRXZlbnQ8TW91c2VFdmVudD4odGhpcy5lbCwgJ21vdXNlZW50ZXInLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShcclxuICAgICAgc3RvcFByb3BhZ2F0aW9uKCksXHJcbiAgICAgIG1hcCgoKSA9PiB0cnVlKVxyXG4gICAgKTtcclxuICAgIGNvbnN0IG1vdXNlTGVhdmUgPSBmcm9tRXZlbnQ8TW91c2VFdmVudD4odGhpcy5lbCwgJ21vdXNlbGVhdmUnLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShcclxuICAgICAgc3RvcFByb3BhZ2F0aW9uKCksXHJcbiAgICAgIG1hcCgoKSA9PiBmYWxzZSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gbWVyZ2UobW91c2VFbnRlciwgbW91c2VMZWF2ZSk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgIC8vIEFjdGl2YXRlIHBvaW50ZXIgZXZlbnRzIG9uIERlc2t0b3Agb25seVxyXG4gICAgICBpZiAoISh0aGlzLnBsYXRmb3JtLklPUyB8fCB0aGlzLnBsYXRmb3JtLkFORFJPSUQpICYmICF0aGlzLmNtcC5wb2ludGVyRXZlbnRzRGlzYWJsZWQpIHtcclxuICAgICAgICB0aGlzLmFjdGl2YXRlUG9pbnRlckV2ZW50cygpLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKSkuc3Vic2NyaWJlKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFVwZGF0ZSBzY3JvbGxiYXIgdGh1bWIgd2hlbiB2aWV3cG9ydCBpcyBzY3JvbGxlZCBhbmQgd2hlbiBzY3JvbGxiYXIgY29tcG9uZW50IGlzIHVwZGF0ZWRcclxuICAgICAgbWVyZ2UodGhpcy5jbXAuc2Nyb2xsZWQsIHRoaXMuY21wLnVwZGF0ZWQpLnBpcGUoXHJcbiAgICAgICAgdGFwKCgpID0+IHRoaXMudGh1bWI/LnVwZGF0ZSgpKSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5kZXN0cm95ZWQubmV4dCgpO1xyXG4gICAgdGhpcy5kZXN0cm95ZWQuY29tcGxldGUoKTtcclxuXHJcbiAgICAvLyBDbGVhbiB1cCB2aWV3cG9ydCBzdHJlYW1zIGlmIHVzZWRcclxuICAgIGlmICh0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkICYmIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQpIHtcclxuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZC5jb21wbGV0ZSgpO1xyXG4gICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkLmNvbXBsZXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2V0SG92ZXJlZCh2YWx1ZTogYm9vbGVhbik6IHZvaWQ7XHJcbn1cclxuIl19